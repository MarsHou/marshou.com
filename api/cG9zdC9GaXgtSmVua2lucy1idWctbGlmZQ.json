{"title":"被Jenkins坑过的日子","date":"2019-07-12T02:57:25.000Z","link":"post/Fix-Jenkins-bug-life","comments":true,"tags":["Jenkins"],"updated":"2019-08-20T05:53:20.781Z","content":"<h2 id=\"前言\">前言<a href=\"post/Fix-Jenkins-bug-life#前言\"></a></h2><h3 id=\"环境\">环境<a href=\"post/Fix-Jenkins-bug-life#环境\"></a></h3><p>MacOS</p>\n<h3 id=\"场景\">场景<a href=\"post/Fix-Jenkins-bug-life#场景\"></a></h3><p>使用Python 抓取一个JS 动态渲染的页面，使用到了Scrapy、Scrapy-Splash 框架，运用了Doker 容器。</p>\n<h2 id=\"坑来了\">坑来了<a href=\"post/Fix-Jenkins-bug-life#坑来了\"></a></h2><h3 id=\"No1-、Jenkins-里直接写Scrapy、Pip-等命令出现Command-not-found-错误\">No1 、Jenkins 里直接写Scrapy、Pip 等命令出现Command not found 错误<a href=\"post/Fix-Jenkins-bug-life#No1-、Jenkins-里直接写Scrapy、Pip-等命令出现Command-not-found-错误\"></a></h3><p><strong>案件分析：</strong>先看看Jenkins 的环境变量，进入Jenkins 首页 -&gt; <code>Mange Jenkins</code> -&gt; <code>System Information</code>, 找到<code>Environment Variables</code> （环境变量）表格，在表格里找到<code>PATH</code>的值，默认是<code>/usr/bin:/bin:/usr/sbin:/sbin</code>, 再看看你的<code>pip</code>、<code>scrapy</code> 安装在哪的？</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> which pip</span><br><span class=\"line\">/usr/local/bin/pip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">$</span> which scrapy</span><br><span class=\"line\">/usr/local/bin/scrapy</span><br></pre></td></tr></table></div></figure>\n<p>So. Why command not found? Because may be it.</p>\n<p><strong>解决办法：</strong>就是给Jenkins 修改环境变量，我尝试到的办法是在<code>Configura System</code> -&gt; <code>Global properties</code> 里勾上<code>Environment variables</code> 增加键值对<code>Name</code> 填写<code>PATH</code>， <code>Value</code> 填写<code>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</code>， （没有尝试只填写/usr/local/bin会怎样，有钻研精神的同学可以试试）。</p>\n<h3 id=\"No2、-在构建的脚本里执行引入了第三方框架的Python-文件，出现ImportError-No-module-named-错误\">No2、 在构建的脚本里执行引入了第三方框架的<code>Python</code> 文件，出现ImportError: No module named ** 错误<a href=\"post/Fix-Jenkins-bug-life#No2、-在构建的脚本里执行引入了第三方框架的Python-文件，出现ImportError-No-module-named-错误\"></a></h3><p><strong>案件分析：</strong> 我这个爬虫的执行文件里内容如下</p>\n<p><code>main.py</code></p>\n<figure class=\"highlight python\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># @Time    : 2018/11/29 15:58</span></span><br><span class=\"line\"><span class=\"comment\"># @Author  : Mars</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> scrapy <span class=\"keyword\">import</span> cmdline</span><br><span class=\"line\"></span><br><span class=\"line\">cmdline.execute([<span class=\"string\">'scrapy'</span>, <span class=\"string\">'crawl'</span>, <span class=\"string\">'此处为爬虫入口程序名'</span>])</span><br></pre></td></tr></table></div></figure>\n<p>在Terminal 执行<figure class=\"highlight python\"><figcaption><span>main.py``` 完全没问题，但部署到Jenkins 上就出现了如下错误</span></figcaption><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">```shell</span><br><span class=\"line\"> $ /bin/sh -xe /Users/Shared/Jenkins/tmp/jenkins4266129241674795365.sh</span><br><span class=\"line\">+ python main.py</span><br><span class=\"line\">Traceback (most recent call last):</span><br><span class=\"line\">  File <span class=\"string\">\"main.py\"</span>, line <span class=\"number\">20</span>, <span class=\"keyword\">in</span> &lt;module&gt;</span><br><span class=\"line\">    <span class=\"keyword\">from</span> scrapy <span class=\"keyword\">import</span> cmdline</span><br><span class=\"line\">  File <span class=\"string\">\"/Library/Python/2.7/site-packages/scrapy/__init__.py\"</span>, line <span class=\"number\">27</span>, <span class=\"keyword\">in</span> &lt;module&gt;</span><br><span class=\"line\">    <span class=\"keyword\">from</span> . <span class=\"keyword\">import</span> _monkeypatches</span><br><span class=\"line\">  File <span class=\"string\">\"/Library/Python/2.7/site-packages/scrapy/_monkeypatches.py\"</span>, line <span class=\"number\">20</span>, <span class=\"keyword\">in</span> &lt;module&gt;</span><br><span class=\"line\">    <span class=\"keyword\">import</span> twisted.persisted.styles  <span class=\"comment\"># NOQA</span></span><br><span class=\"line\">ImportError: No module named twisted.persisted.styles</span><br></pre></td></tr></table></div></figure></p>\n<p>别怀疑你的<code>twisted</code>包是不是有问题，网上找了2、3天没找到同款条件下的同款问题，更没有同款答案了。我尝试了</p>\n<ul>\n<li>升级Jenkins</li>\n<li>卸载重装<code>twisted</code></li>\n<li>增加PYTHONPATH</li>\n<li>增加PATH</li>\n<li>…</li>\n</ul>\n<p>都没解决，最终我直接把程序放在桌面上，通过在Jenkins 里写一段</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /Users/Mars/Documents</span><br></pre></td></tr></table></div></figure>\n<p>构建Jenkins 的时候又报错了</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> /bin/sh -xe /Users/Shared/Jenkins/tmp/jenkins3643154797228771836.sh</span><br><span class=\"line\">+ cd /Users/Mars/Documents</span><br><span class=\"line\">/Users/Shared/Jenkins/tmp/jenkins3643154797228771836.sh: line 2: cd: /Users/gatscm2/Documents: Permission denied</span><br></pre></td></tr></table></div></figure>\n<p><code>Permission denied</code> 没权限，这时候我恍然大明白， 马上在Jenkins 的shell 脚本里敲下两个英文字母<code>id</code> 再构建一下。</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> /bin/sh -xe /Users/Shared/Jenkins/tmp/jenkins4686859629267551489.sh</span><br><span class=\"line\">+ id</span><br><span class=\"line\">uid=267(jenkins) gid=267(jenkins) egid=1(daemon) groups=267(jenkins),12(everyone),20(staff),61(localaccounts),79(_appserverusr),80(admin),81(_appserveradm),98(_lpadmin),702(com.apple.sharepoint.group.2),33(_appstore),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),101(com.apple.access_screensharing-disabled),102(com.apple.access_ssh-disabled)</span><br></pre></td></tr></table></div></figure>\n<p>这下终于通了，原来Jenkins 系统里的所有操作都是以电脑用户<strong>Jenkins</strong> 的身份操作的，所以为什么会各种找不到module的情况出现。找到问题源头了，接下来解决问题。</p>\n<p><strong>解决办法：</strong> 更改Jenkins 系统执行时的身份</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>停止Jenkins</span><br><span class=\"line\"><span class=\"meta\">$</span> sudo launchctl unload /Library/LaunchDaemons/org.jenkins-ci.plist</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> 修改group 和user</span><br><span class=\"line\"><span class=\"meta\">$</span> sudo vim +1 +/daemon +’s/daemon/staff/’ +/daemon +’s/daemon/Mars’ +wq org.jenkins-ci.plist</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> 修改之前文件的归属权限</span><br><span class=\"line\"><span class=\"meta\">$</span> sudo chown -R Mars:staff /Users/Shared/Jenkins/</span><br><span class=\"line\"><span class=\"meta\">$</span> sudo chown -R Mars:staff /var/log/jenkins</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> 开始Jenkins</span><br><span class=\"line\"><span class=\"meta\">$</span> sudo launchctl load /Library/LaunchDaemons/org.jenkins-ci.plist</span><br></pre></td></tr></table></div></figure>\n<p>第二步也可以直接打开文件修改，</p>\n<p>找到key 标签为<code>GroupName</code> 对应的string 标签，把<code>daemon</code> 用<code>staff</code>  替换掉</p>\n<p>找到key 标签为<code>UserName</code> 对应的string 标签，把<code>daemon</code> 用你电脑平常使用的用<strong>user name</strong> 替换掉</p>\n<p>验证是否修改成功，再用<code>id</code> 命令试试</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span> /bin/sh -xe /Users/Shared/Jenkins/tmp/jenkins1779228406794725443.sh</span><br><span class=\"line\">+ id</span><br><span class=\"line\">uid=502(Mars) gid=20(staff) groups=20(staff),702(com.apple.sharepoint.group.2),12(everyone),61(localaccounts),79(_appserverusr),80(admin),81(_appserveradm),98(_lpadmin),33(_appstore),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),101(com.apple.access_screensharing-disabled),102(com.apple.access_ssh-disabled)</span><br></pre></td></tr></table></div></figure>\n<p>好了，问题解决了。<code>此处建议把Jenkins 的用户群组和用户名称改成电脑平时使用的账号，可以避免很多未知的坑</code></p>\n<h3 id=\"No3、-Jenkins-使用GIT-插件后使用clone-代码，SSH-Key问题\">No3、 Jenkins 使用GIT 插件后使用clone 代码，SSH Key问题<a href=\"post/Fix-Jenkins-bug-life#No3、-Jenkins-使用GIT-插件后使用clone-代码，SSH-Key问题\"></a></h3><p><strong>案件分析：</strong> 在Jenkins 里使用git 出现权限问题，你可能记得你明明已经配好了SSH Key 的公钥，而且在本地shell 命令使用<code>git clone **</code> 也没问题，为什么Jenkins 里就不行了。</p>\n<p><strong>解决办法：</strong> 用电脑本机的<code>.ssh</code> 文件替换掉Jenkins 目录下的<code>.ssh</code> 文件，  没错！又是因为Jenkins 有自己的一套私钥、公钥。</p>\n<h3 id=\"Ending\">Ending<a href=\"post/Fix-Jenkins-bug-life#Ending\"></a></h3><p>这是第一次正正经经的写经验输出，有更好的解决思路、办法，欢迎留言抨击，共同成长。</p>\n<p>再说说写的过程中，怎么碰到的问题，怎么去分析，怎么去解决。特别是怎么去分析可能在解决问题之后会觉得解决的思路很傻，但是在没有外力帮助的情况下，自己是怎么去解决的，记录下来后。</p>\n<p>转过身来看，嗯！这就是成长！</p>\n","next":{"title":"Upgrade node on mac","link":"post/upgrade-node-on-mac"},"plink":"http://marshou.github.io/post/Fix-Jenkins-bug-life/","toc":[{"title":"前言","id":"前言","index":"1","children":[{"title":"环境","id":"环境","index":"1.1"},{"title":"场景","id":"场景","index":"1.2"}]},{"title":"坑来了","id":"坑来了","index":"2","children":[{"title":"No1 、Jenkins 里直接写Scrapy、Pip 等命令出现Command not found 错误","id":"No1-、Jenkins-里直接写Scrapy、Pip-等命令出现Command-not-found-错误","index":"2.1"},{"title":"No2、 在构建的脚本里执行引入了第三方框架的<code>Python</code> 文件，出现ImportError: No module named ** 错误","id":"No2、-在构建的脚本里执行引入了第三方框架的Python-文件，出现ImportError-No-module-named-错误","index":"2.2"},{"title":"No3、 Jenkins 使用GIT 插件后使用clone 代码，SSH Key问题","id":"No3、-Jenkins-使用GIT-插件后使用clone-代码，SSH-Key问题","index":"2.3"},{"title":"Ending","id":"Ending","index":"2.4"}]}],"reward":true,"copyright":{"author":"Mars Hou","link":"<a href=\"http://marshou.github.io/post/Fix-Jenkins-bug-life/\" title=\"被Jenkins坑过的日子\">http://marshou.github.io/post/Fix-Jenkins-bug-life/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)"}}